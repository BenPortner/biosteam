
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>biosteam.units.balance &#8212; BioSTEAM 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">BioSTEAM 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for biosteam.units.balance</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Sat Sep  1 17:35:28 2018</span>

<span class="sd">@author: yoelr</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">biosteam</span> <span class="k">import</span> <span class="n">np</span><span class="p">,</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">Unit</span>
<span class="kn">from</span> <span class="nn">biosteam.utils</span> <span class="k">import</span> <span class="n">MissingStream</span>
<span class="kn">from</span> <span class="nn">biosteam.meta_classes</span> <span class="k">import</span> <span class="n">metaFinal</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MassBalance&#39;</span><span class="p">]</span>

<span class="c1"># %% Mass Balance Unit</span>

<div class="viewcode-block" id="MassBalance"><a class="viewcode-back" href="../../../MassBalance.html#biosteam.MassBalance">[docs]</a><span class="k">class</span> <span class="nc">MassBalance</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">metaFinal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Unit object that changes net input flow rates to satisfy output flow rates. This calculation is based on mass balance equations for specified species. </span>

<span class="sd">    **Parameters**</span>

<span class="sd">        **species:** tuple[str] Species that will be used to solve mass balance linear equations. The number of species must be same as the number of input streams varied.</span>

<span class="sd">        **streams:** tuple[int] Indices of input streams that can vary in net flow rate</span>

<span class="sd">        **exact:** [bool] True if exact flow rate solution is required for the specified species.</span>

<span class="sd">        **balance:** [str] Should be one of the following:</span>
<span class="sd">                  * &#39;flow&#39;: Satisfy output flow rates</span>
<span class="sd">                  * &#39;fraction&#39;: Satisfy net output molar fractions</span>

<span class="sd">    .. Note::</span>

<span class="sd">        This is an end-of-the-line/final class that cannot be inherited.</span>

<span class="sd">    **Examples**</span>
<span class="sd">    </span>
<span class="sd">        :doc:`MassBalance Example`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;Balance&#39;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_has_cost</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_N_outs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">outs</span><span class="o">=</span><span class="p">(),</span> <span class="n">ins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">streams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="s1">&#39;flow&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_ins</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_outs</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span><span class="p">[</span><span class="s1">&#39;spindex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">_IDs</span><span class="o">.</span><span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="n">species</span><span class="p">,</span>
                        <span class="s1">&#39;streams&#39;</span><span class="p">:</span> <span class="n">streams</span><span class="p">,</span>
                        <span class="s1">&#39;exact&#39;</span><span class="p">:</span> <span class="n">exact</span><span class="p">,</span>
                        <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">balance</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_ins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize input streams.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">MissingStream</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N_ins</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">Stream</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">ins</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">Stream</span><span class="p">(</span><span class="n">ins</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">ins</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">Stream</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N_ins</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">Stream</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ins</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_init_outs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize output streams.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Stream</span><span class="p">(</span><span class="n">outs</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">Stream</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">outs</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">outs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">MissingStream</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N_outs</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">outs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Stream</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N_outs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Stream</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s1">&#39;exact&#39;</span><span class="p">]</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span>
        
        <span class="c1"># Make sure balance type is valid</span>
        <span class="k">if</span> <span class="n">balance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;flow&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Balance type must be one of the following: &#39;flow&#39;, &#39;fraction&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Cach correct solver and make sure linear system of equations is square to achieve exact solution</span>
        <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span>
            <span class="n">species_IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
            <span class="n">sID</span><span class="p">,</span> <span class="n">s_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_IDs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="s1">&#39;streams&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sID</span> <span class="o">!=</span> <span class="n">s_index</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;Length of species (</span><span class="si">{sID}</span><span class="s2">) must be equal to the length of streams_index (</span><span class="si">{s_index}</span><span class="s2">) when exact solution is needed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span>

        <span class="c1"># Cach indices for species and solver</span>
        <span class="n">spindex</span> <span class="o">=</span> <span class="n">cached</span><span class="p">[</span><span class="s1">&#39;spindex&#39;</span><span class="p">]</span>
        <span class="n">cached</span><span class="p">[</span><span class="s1">&#39;bal_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spindex</span><span class="p">(</span><span class="n">specie</span><span class="p">)</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="n">species_IDs</span><span class="p">]</span>
        <span class="n">cached</span><span class="p">[</span><span class="s1">&#39;linalg_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve mass balance by iteration.&quot;&quot;&quot;</span>
        <span class="c1"># SOLVING BY ITERATION TAKES 15 LOOPS FOR 2 STREAMS</span>
        <span class="c1"># SOLVING BY LEAST-SQUARES TAKES 40 LOOPS</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span>
        <span class="n">cached</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span>
        <span class="n">stream_index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;streams&#39;</span><span class="p">]</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="n">cached</span><span class="p">[</span><span class="s1">&#39;linalg_solver&#39;</span><span class="p">]</span>

        <span class="c1"># Set up constant and variable streams</span>
        <span class="n">vary</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Streams to vary in mass balance</span>
        <span class="n">constant</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Constant streams</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ins</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stream_index</span><span class="p">:</span>
                <span class="n">vary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ins</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">constant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ins</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Species indices used in mass balace</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">cached</span><span class="p">[</span><span class="s1">&#39;bal_index&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">balance</span> <span class="o">==</span> <span class="s1">&#39;flow&#39;</span><span class="p">:</span>
            <span class="c1"># Perform the following calculation: Ax = b = f - g</span>
            <span class="c1"># Where:</span>
            <span class="c1">#    A = flow rate array</span>
            <span class="c1">#    x = factors</span>
            <span class="c1">#    b = target flow rates</span>
            <span class="c1">#    f = output flow rates</span>
            <span class="c1">#    g = constant input flow rates</span>

            <span class="c1"># Solve linear equations for mass balance</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vary</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_out</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">mol</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">constant</span><span class="p">])</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">g</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="c1"># Set flow rates for input streams</span>
            <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vary</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="o">*</span> <span class="n">factor</span>

        <span class="k">elif</span> <span class="n">balance</span> <span class="o">==</span> <span class="s1">&#39;fraction&#39;</span><span class="p">:</span>
            <span class="c1"># Perform the following calculation:</span>
            <span class="c1"># Ax = b</span>
            <span class="c1">#    = sum( A_ * x_guess + g_ )f - g</span>
            <span class="c1">#    = A_ * x_guess * f - O</span>
            <span class="c1"># O  = sum(g_)*f - g</span>
            <span class="c1"># Where:</span>
            <span class="c1"># A_ is flow array for all species</span>
            <span class="c1"># g_ is constant flows for all species</span>
            <span class="c1"># Same variable definitions as in &#39;flow&#39;</span>

            <span class="c1"># Set all variables</span>
            <span class="n">A_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vary</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vary</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molfrac_out</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">g_</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">constant</span><span class="p">])</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">O</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">g_</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span> <span class="o">-</span> <span class="n">g</span>

            <span class="c1"># Solve by iteration</span>
            <span class="n">x_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">not_converged</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">not_converged</span><span class="p">:</span>
                <span class="c1"># Solve linear equations for mass balance</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">A_</span> <span class="o">*</span> <span class="n">x_guess</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">f</span> <span class="o">+</span> <span class="n">O</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">not_converged</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(((</span><span class="n">x_new</span> <span class="o">-</span> <span class="n">x_guess</span><span class="p">)</span><span class="o">/</span><span class="n">x_new</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.00001</span>
                <span class="n">x_guess</span> <span class="o">=</span> <span class="n">x_new</span>

            <span class="c1"># Set flow rates for input streams</span>
            <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">vary</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="o">*</span> <span class="n">factor</span>

    <span class="c1"># Setting input and output streams do not change sources or sinks</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[:] Input streams&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span>

    <span class="nd">@ins</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">streams</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ins</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">streams</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[:] Output streams&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span>

    <span class="nd">@outs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">outs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">streams</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">streams</span></div>


<span class="c1"># %% Energy Balance Unit</span>

<span class="k">class</span> <span class="nc">EnergyBalance</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">metaFinal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Unit object that changes a stream temperature, flow rate, or vapor fraction to satisfy energy balance.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        **index:** [int] Index of stream that can vary in temperature, flow rate, or vapor fraction.</span>
<span class="sd">        </span>
<span class="sd">        **Type:** [str] Should be one of the following</span>
<span class="sd">            * &#39;T&#39;: Vary temperature of output stream</span>
<span class="sd">            * &#39;V&#39;: Vary vapor fraction of output stream</span>
<span class="sd">            * &#39;F&#39;: Vary flow rate of input/output stream</span>
<span class="sd">        </span>
<span class="sd">        **Qin:** *[float]* Additional energy input.</span>

<span class="sd">    .. Note::</span>

<span class="sd">        This is an end-of-the-line/final class that cannot be inherited.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
               <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Qin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;Balance&#39;</span>
    <span class="n">_has_cost</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_graphics</span> <span class="o">=</span> <span class="n">MassBalance</span><span class="o">.</span><span class="n">_graphics</span>
    <span class="n">_init_ins</span> <span class="o">=</span> <span class="n">MassBalance</span><span class="o">.</span><span class="n">_init_ins</span>
    <span class="n">_init_outs</span> <span class="o">=</span> <span class="n">MassBalance</span><span class="o">.</span><span class="n">_init_outs</span>
    
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="c1"># Get arguments</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ins</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
        <span class="n">Type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
        <span class="n">Qin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Qin&#39;</span><span class="p">]</span>
        
        <span class="c1"># Pop out required streams</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
            <span class="n">s_in</span> <span class="o">=</span> <span class="n">ins</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">s_out</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Find required enthalpy</span>
        <span class="n">H_in</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">H</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ins</span><span class="p">)</span> <span class="o">+</span> <span class="n">Qin</span>
        <span class="n">H_out</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">H</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">)</span>
        <span class="n">H_s</span> <span class="o">=</span> <span class="n">H_out</span> <span class="o">-</span> <span class="n">H_in</span>
        
        <span class="c1"># Set enthalpy</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="o">-</span><span class="n">H_s</span>
        <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">enable_phases</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">VLE</span><span class="p">(</span><span class="n">Qin</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">H</span> <span class="o">-</span> <span class="n">H_s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">mol</span> <span class="o">*=</span> <span class="p">(</span><span class="n">s_out</span><span class="o">.</span><span class="n">H</span> <span class="o">-</span> <span class="n">s_in</span><span class="o">.</span><span class="n">H</span><span class="p">)</span><span class="o">/</span><span class="n">H_s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Type must be &#39;T&#39;, &#39;V&#39; or &#39;F&#39;, not &#39;</span><span class="si">{Type}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            
        
        
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">BioSTEAM 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Yoel Cortes-Pena and Guest Group.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>